/*******************************************************************************

scrollstream.jquery.min.js (v1.0.2)
https://github.com/photoshelter/scrollstream

Copyright 2012 PhotoShelter, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

*******************************************************************************/

;(function(g,i){var j=function(a,c){this.opts=g.extend({},{name:"scrollstream",context:null,debug:!1,events:{req:"req.scrollstream",resp:"resp.scrollstream",start:"start.scrollstream",stop:"stop.scrollstream"},timers:{debounce:500,feedback:200,queue:100},loading:null,classes:{ol:null,li:null}},c);this.jq={};this.consts={};this.intervals={};this.reqQ=[];this.respQ=[];this.jq.$elem=g(a);this.jq.$elem.html(this._makeHtml());g.extend(this.jq,this._makeJq());this.jq.$context.css("overflow-y","scroll")};
j.prototype={opts:null,jq:null,consts:null,intervals:null,reqQ:null,respQ:null,_makeHtml:function(){var a=this.opts.name+"-block",c='<div id="'+(this.opts.name+"-pre")+'"></div>',d=this.opts.classes.ol;return c+(d?'<ol id="'+a+'" class="'+d+'"></ol>':'<ol id="'+a+'"></ol>')},_makeJq:function(){return{$context:"function"===typeof this.opts.context?this.opts.context():g(i),$pre:g("#"+this.opts.name+"-pre"),$block:g("#"+this.opts.name+"-block")}},preRows:null,scrolled:null,resized:null,init:function(a){this.opts.buffer=
a.buffer;this.opts.item=a.item;if("number"!==typeof this.opts.buffer||"number"!==typeof this.opts.item.count||"number"!==typeof this.opts.item.height||"number"!==typeof this.opts.item.width)throw new TypeError("Malformed ScrollStream init type");if(1>this.opts.item.count)this.jq.$block.html("");else{2>this.opts.buffer&&(this.opts.buffer=2);this.consts=this._calcConsts();this.jq.$elem.height(this.consts.contRows*this.opts.item.height);this.jq.$block.height(this.consts.blockRows*this.opts.item.height);
this.opts.debug&&(console.log("[init]"),console.log("itemsPerRow:   "+this.consts.itemsPerRow),console.log("contRows:      "+this.consts.contRows),console.log("blockRows:     "+this.consts.blockRows),console.log("itemsPerBlock: "+this.consts.itemsPerBlock),console.log("----------------------------------------"));this._startQueues();this._wireRespEvent();this.jq.$context.scrollTop(0);this.jq.$pre.height(0);this.preRows=0;this._handleScroll("reload",0,this.consts.itemsPerBlock,null,!1);this.resized=
this.scrolled=!1;var c=this;this.jq.$context.scroll(function(){c.scrolled=true});this.intervals.feedback=i.setInterval(function(){return c._feedback.apply(c)},this.opts.timers.feedback)}},_calcConsts:function(){var a=this.opts.item,c=Math.floor(this.jq.$block.width()/a.width);1>c&&(c=1);var d=Math.ceil(a.count/c),b=Math.ceil(this.jq.$context.height()/a.height),b=1>b?1+2*this.opts.buffer:b+2*this.opts.buffer;b>d&&(b=d);var e=b*c;a.count<e&&(e=a.count);return{itemsPerRow:c,contRows:d,blockRows:b,itemsPerBlock:e}},
_startQueues:function(){var a=this;this.intervals.queue=i.setInterval(function(){for(;0<a.reqQ.length&&0<a.respQ.length;){for(var c=a.reqQ[0],d=!1,b=0,e=a.respQ.length;b<e;b++){var f=a.respQ[b];if(c.start===f.start&&c.size===f.liHtml.length){a.reqQ.shift();a.respQ.splice(b,1);a._handleResp(c,f);d=!0;break}}if(!d)break}},this.opts.timers.queue)},_wireRespEvent:function(){var a=this;this.jq.$elem.on(this.opts.events.resp,function(c,d){if("number"!==typeof d.start||!d.liHtml||!(d.liHtml instanceof Array)||
d.liData&&"object"!==typeof d.liData)throw new TypeError("Malformed ScrollStream response type");a.respQ.push(d)})},_feedback:function(){if(this.resized||this.scrolled){var a=this._calcPre(Math.floor(this.jq.$context.scrollTop()/this.opts.item.height));if(!this.resized&&a===this.preRows)this.scrolled=!1;else{this.jq.$pre.height(a*this.opts.item.height);var c,d,b,e;b=a-this.preRows;if(!this.resized&&Math.abs(b)<this.consts.blockRows){var f=0!==this.opts.item.count%this.consts.itemsPerRow;0>b?(c="up",
d=a*this.consts.itemsPerRow,b=-b*this.consts.itemsPerRow,e=this.preRows===this.consts.contRows-this.consts.blockRows&&f?b-this.consts.itemsPerRow+this.opts.item.count%this.consts.itemsPerRow:b):(c="down",d=this.consts.itemsPerRow*(this.preRows+this.consts.blockRows),e=b*this.consts.itemsPerRow,b=a===this.consts.contRows-this.consts.blockRows&&f?e-this.consts.itemsPerRow+this.opts.item.count%this.consts.itemsPerRow:e)}else c="reload",d=a*this.consts.itemsPerRow,e=null,b=d+this.consts.itemsPerBlock<=
this.opts.item.count?this.consts.itemsPerBlock:this.consts.itemsPerBlock-this.consts.itemsPerRow+this.opts.item.count%this.consts.itemsPerRow;this._handleScroll(c,d,b,e,!0);this.preRows=a;this.resized=this.scrolled=!1}}},_calcPre:function(a){return this.opts.item.count<=this.consts.itemsPerBlock?0:a<this.opts.buffer?0:a<this.consts.contRows-this.consts.blockRows+this.opts.buffer?a-this.opts.buffer:this.consts.contRows-this.consts.blockRows},debounceTimer:null,_handleScroll:function(a,c,d,b,e){this._modifyBlock({type:a,
start:c,size:d,remove:b});if(e){this.debounceTimer&&clearTimeout(this.debounceTimer);var f=this;this.debounceTimer=i.setTimeout(function(){return f._fillPlaceholders.apply(f)},this.opts.timers.debounce)}else this._fillPlaceholders()},_fillPlaceholders:function(){var a,c=[],d=this;this.jq.$block.children().each(function(b){0===b&&(a=parseInt(g(this).attr("id").split(d.opts.name+"-id-")[1],10));c.push(g(this.firstChild).hasClass(d.opts.name+"-loading"))});for(var b=this._findRuns(c),e=0,f=b.length;e<
f;e++)if(!0===b[e].value){var h={start:a+b[e].start,size:b[e].count};this.reqQ.push(h);this.jq.$elem.trigger(this.opts.events.req,h)}},_findRuns:function(a){for(var c=[],d,b,e,f=0,h=a.length;f<h;f++)0===f?(d=0,b=1,e=a[f]):a[f]===e?b++:(c.push({start:d,count:b,value:e}),d=f,b=1,e=a[f]),f===a.length-1&&c.push({start:d,count:b,value:e});return c},_modifyBlock:function(a){var c=this.opts.events.start;c&&this.jq.$elem.trigger(c);for(var c='<div class="'+this.opts.name+'-loading"></div>',d="function"===
typeof this.opts.loading?this.opts.loading():"",b="",e=0,f=a.size;e<f;e++)var h=this.opts.name+"-id-"+(a.start+e),g=this.opts.classes.li,h=g?'<li id="'+h+'" class="'+g+'">':'<li id="'+h+'">',h=h+(c+d+"</li>"),b=b+h;this.opts.debug&&(console.log("["+a.type+"]"),console.log("start+size:    "+a.start+"+"+a.size),console.log("remove:        "+a.remove),console.log("----------------------------------------"));switch(a.type){case "down":this.jq.$block.append(b).children().slice(0,a.remove).remove();break;
case "up":this.jq.$block.prepend(b).children().slice(-a.remove).remove();break;case "reload":this.jq.$block.html(b)}},_handleResp:function(a,c){var d=this.opts.name+"-id-"+(a.start+a.size),b=g("#"+(this.opts.name+"-id-"+a.start));b.add(b.nextUntil("#"+d)).each(function(a){var b=g(this).html(c.liHtml[a]);if(c.liData&&"object"===typeof c.liData[a])for(var d in c.liData[a])c.liData[a].hasOwnProperty(d)&&b.data(d,c.liData[a][d]);c.liClass&&"string"===typeof c.liClass[a]&&b.addClass(c.liClass[a])});(d=
this.opts.events.stop)&&this.jq.$elem.trigger(d)},getHeight:function(){return this.consts.contRows*this.opts.item.height},getItemsPerRow:function(){return this.consts.itemsPerRow},resize:function(){if(this.opts.item){var a=this._calcConsts();a.itemsPerRow===this.consts.itemsPerRow&&a.blockRows===this.consts.blockRows||(this.reqQ=[],this.respQ=[],this.consts=a,this.jq.$elem.height(this.consts.contRows*this.opts.item.height),this.jq.$block.height(this.consts.blockRows*this.opts.item.height),this.resized=
!0)}},reset:function(){this.jq.$elem.off();clearInterval(this.intervals.feedback);clearInterval(this.intervals.queue);this.consts={};this.intervals={};this.reqQ=[];this.respQ=[];this.resized=this.scrolled=this.preRows=null;delete this.opts.items;delete this.opts.buffer;this.jq.$block.html("")},destroy:function(){this.reset();this.jq.$elem.replaceWith('<div id="'+this.opts.name+'"></div>')}};g.fn.scrollStream=function(a){return this.each(function(){g.data(this,"scrollStream")||g.data(this,"scrollStream",
new j(this,a))})}})(jQuery,window);
